@using ZorgmeldSysteem.Blazor.Models.DTOs.Object
@using ZorgmeldSysteem.Blazor.ViewModels.Object
@using ZorgmeldSysteem.Blazor.Services.Api
@using ZorgmeldSysteem.Blazor.Services.Business
@using ZorgmeldSysteem.Blazor.Models.DTOs.Company
@using ZorgmeldSysteem.Blazor.Models.Enums
@inject ObjectApiService ObjectApiService
@inject TicketApiService TicketApiService
@inject QRCodeService QRService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Nieuw Object Aanmaken</PageTitle>

<div class="container mt-4">
    <h3>Nieuw Object Aanmaken</h3>

    @if (!string.IsNullOrEmpty(viewModel.ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @viewModel.ErrorMessage
        </div>
    }

    @if (viewModel.IsLoading)
    {
        <LoadingSpinner Message=" laden..." />
    }
    else if (viewModel.ObjectCreated && viewModel.CreatedObject != null)
    {
        <!-- Success + QR Code -->
        <div class="alert alert-success">
            <h4>Object succesvol aangemaakt!</h4>
            <p><strong>Object:</strong> @viewModel.CreatedObject.Name</p>
            <p><strong>Code:</strong> @viewModel.CreatedObject.ObjectCode</p>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>QR-Code voor dit object</h5>
            </div>
            <div class="card-body text-center">
                @if (!string.IsNullOrEmpty(viewModel.QRCodeBase64))
                {
                    <img src="@viewModel.QRCodeBase64" alt="QR Code" class="img-fluid mb-3" style="max-width: 300px;" />
                    <br />
                    <button class="btn btn-primary" @onclick="DownloadQRCode">
                        <i class="bi bi-download"></i> Download QR-Code
                    </button>
                    <button class="btn btn-secondary" @onclick="PrintQRCode">
                        <i class="bi bi-printer"></i> Print QR-Code
                    </button>
                }
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    Scan deze QR-code bij het aanmaken van een ticket om automatisch dit object te selecteren.
                </small>
            </div>
        </div>

        <div class="mt-3">
            <button class="btn btn-success" @onclick="CreateAnother">Nog een object aanmaken</button>
            <button class="btn btn-outline-secondary" @onclick="GoToObjectList">Naar objectenlijst</button>
        </div>
    }
    else if (viewModel.ShowPreview)
    {
        <!-- Preview scherm met QR-code VOOR opslaan -->
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <h5><i class="bi bi-eye"></i> Preview - Object is nog NIET opgeslagen</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Object Details:</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>Bedrijf:</th>
                                <td>@viewModel.GetCompanyName(viewModel.NewObject.CompanyID)</td>
                            </tr>
                            <tr>
                                <th>Object Code:</th>
                                <td><strong>@viewModel.NewObject.ObjectCode</strong></td>
                            </tr>
                            <tr>
                                <th>Naam:</th>
                                <td>@viewModel.NewObject.Name</td>
                            </tr>
                            <tr>
                                <th>Locatie:</th>
                                <td>@viewModel.NewObject.Location</td>
                            </tr>
                            @if (!string.IsNullOrEmpty(viewModel.NewObject.Brand))
                            {
                                <tr>
                                    <th>Merk:</th>
                                    <td>@viewModel.NewObject.Brand</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(viewModel.NewObject.Model))
                            {
                                <tr>
                                    <th>Model:</th>
                                    <td>@viewModel.NewObject.Model</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(viewModel.NewObject.SerialNumber))
                            {
                                <tr>
                                    <th>Serienummer:</th>
                                    <td>@viewModel.NewObject.SerialNumber</td>
                                </tr>
                            }
                        </table>
                    </div>
                    <div class="col-md-6 text-center">
                        <h6>QR-Code Preview:</h6>
                        @if (!string.IsNullOrEmpty(viewModel.QRCodeBase64))
                        {
                            <img src="@viewModel.QRCodeBase64" alt="QR Code Preview" class="img-fluid mb-3" style="max-width: 250px;" />
                            <div class="d-flex gap-2 justify-content-center mb-2">
                                <button class="btn btn-sm btn-outline-primary" @onclick="DownloadPreviewQRCode">
                                    <i class="bi bi-download"></i> Download Preview
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="PrintPreviewQRCode">
                                    <i class="bi bi-printer"></i> Print Preview
                                </button>
                            </div>
                            <p class="text-muted mt-2"><small>Let op: Dit is een preview. Na opslaan krijg je de definitieve QR-code.</small></p>
                        }
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2 justify-content-between">
                    <button class="btn btn-secondary" @onclick="BackToForm">
                        <i class="bi bi-arrow-left"></i> Terug naar formulier
                    </button>
                    <button class="btn btn-success btn-lg" @onclick="ConfirmAndSave" disabled="@viewModel.IsSaving">
                        @if (viewModel.IsSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-check-circle"></i> Ja, opslaan in database
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Formulier -->
        <EditForm Model="@viewModel.NewObject" OnValidSubmit="ShowPreview">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Bedrijf *</label>
                        <InputSelect class="form-select" @bind-Value="viewModel.NewObject.CompanyID">
                            <option value="0">-- Selecteer bedrijf --</option>
                            @foreach (var company in viewModel.Companies)
                            {
                                <option value="@company.CompanyID">@company.Name</option>
                            }
                        </InputSelect>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Object Code *</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.ObjectCode" placeholder="Bijv. OBJ-LIFT-001" />
                        <small class="text-muted">Unieke code voor dit object</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Naam *</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.Name" placeholder="Bijv. Personenlift Vleugel A" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Locatie *</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.Location" placeholder="Bijv. Vleugel A, begane grond" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Standaard Prioriteit *</label>
                        <InputSelect @bind-Value="viewModel.NewObject.DefaultPriority" class="form-select">
                            @foreach (Priority p in Enum.GetValues(typeof(Priority)))
                            {
                                <option value="@p">@p</option>
                            }
                        </InputSelect>
                        <small class="text-muted">Voor nieuwe tickets van dit object</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Standaard Reactietijd *</label>
                        <InputSelect @bind-Value="viewModel.NewObject.DefaultReactionTime" class="form-select">
                            @foreach (ReactionTime rt in Enum.GetValues(typeof(ReactionTime)))
                            {
                                <option value="@rt">@rt</option>
                            }
                        </InputSelect>
                    </div>

                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Merk</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.Brand" placeholder="Bijv. Schindler" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.Model" placeholder="Bijv. 3300 AP" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Serienummer</label>
                        <InputText class="form-control" @bind-Value="viewModel.NewObject.SerialNumber" placeholder="Bijv. SCH-2019-4782" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Installatiedatum</label>
                        <InputDate class="form-control" @bind-Value="viewModel.NewObject.InstallationDate" />
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Beschrijving</label>
                <InputTextArea class="form-control" @bind-Value="viewModel.NewObject.Description" rows="3" placeholder="Beschrijving van het object..." />
            </div>

            <div class="mb-3">
                <label class="form-label">Volgende onderhoud</label>
                <InputDate class="form-control" @bind-Value="viewModel.NewObject.NextMaintenance" />
            </div>

            <div class="mb-3">
                <label class="form-label">Aangemaakt door *</label>
                <InputText class="form-control" @bind-Value="viewModel.NewObject.CreatedBy" placeholder="Jouw naam" />
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-eye"></i> Preview & QR-Code
                </button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">Annuleren</button>
            </div>

        </EditForm>
    }
</div>

@code {
    private CreateObjectViewModel viewModel = new();

    protected override async Task OnInitializedAsync()
    {
        viewModel.OnStateChanged += StateHasChanged;
        await viewModel.LoadCompaniesAsync(() => TicketApiService.GetAllCompaniesAsync());
    }

    private void ShowPreview()
    {
        try
        {
            var qrCode = QRService.GeneratePreviewQRCode(viewModel.NewObject.ObjectCode);
            viewModel.SetQRCode(qrCode);
            viewModel.ShowPreviewMode();
        }
        catch (Exception ex)
        {
            viewModel.SetError($"Fout bij genereren preview: {ex.Message}");
        }
    }

    private void BackToForm()
    {
        viewModel.BackToForm();
    }

    private async Task ConfirmAndSave()
    {
        await viewModel.SaveObjectAsync(async () => 
        {
            var result = await ObjectApiService.CreateObjectAsync(viewModel.NewObject);
            
            if (result != null)
            {
                var qrCode = QRService.GenerateObjectQRCode(result.ObjectID);
                viewModel.SetQRCode(qrCode);
            }
            
            return result;
        });
    }

    private async Task DownloadQRCode()
    {
        try
        {
            string base64Data = QRService.GetBase64DataFromDataUrl(viewModel.QRCodeBase64);
            await JSRuntime.InvokeVoidAsync("downloadQRCode", base64Data, 
                $"QRCode-{viewModel.CreatedObject?.ObjectCode}.png");
        }
        catch (Exception ex)
        {
            viewModel.SetError($"Fout bij downloaden: {ex.Message}");
        }
    }

    private async Task DownloadPreviewQRCode()
    {
        try
        {
            string base64Data = QRService.GetBase64DataFromDataUrl(viewModel.QRCodeBase64);
            await JSRuntime.InvokeVoidAsync("downloadQRCode", base64Data, 
                $"PREVIEW-{viewModel.NewObject.ObjectCode}.png");
        }
        catch (Exception ex)
        {
            viewModel.SetError($"Fout bij downloaden preview: {ex.Message}");
        }
    }

    private async Task PrintQRCode()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("printQRCode", viewModel.QRCodeBase64);
        }
        catch (Exception ex)
        {
            viewModel.SetError($"Fout bij printen: {ex.Message}");
        }
    }

    private async Task PrintPreviewQRCode()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("printQRCode", viewModel.QRCodeBase64);
        }
        catch (Exception ex)
        {
            viewModel.SetError($"Fout bij printen preview: {ex.Message}");
        }
    }

    private void CreateAnother()
    {
        viewModel.ResetForm();
    }

    private void GoToObjectList()
    {
        Navigation.NavigateTo("/object");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }

    public void Dispose()
    {
        viewModel.OnStateChanged -= StateHasChanged;
    }
}
