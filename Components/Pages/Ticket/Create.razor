@page "/ticket/create"
@attribute [Authorize(Roles = "Fixility Admin,Bedrijfsbeheerder,Melder")]

@using Microsoft.AspNetCore.Authorization
@using ZorgmeldSysteem.Blazor.ViewModels.Ticket
@using ZorgmeldSysteem.Blazor.Components.Common
@using ZorgmeldSysteem.Blazor.Models.DTOs.Ticket
@using ZorgmeldSysteem.Blazor.Models.DTOs.Company
@using ZorgmeldSysteem.Blazor.Models.DTOs.Mechanic
@using ZorgmeldSysteem.Blazor.Models.DTOs.Object
@using ZorgmeldSysteem.Blazor.Models.Enums
@using ZorgmeldSysteem.Blazor.Services.Api
@using ZorgmeldSysteem.Blazor.Components.Shared
@inject TicketApiService ApiService
@inject ObjectApiService ObjectApiService
@inject NavigationManager Navigation
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Nieuwe Ticket Aanmaken</PageTitle>

<h3>Nieuwe Ticket Aanmaken</h3>

<div class="mb-3">
    <button type="button" class="btn btn-outline-primary" @onclick="OpenQRScanner">
        <i class="bi bi-qr-code-scan"></i> Scan QR-Code
    </button>
    @if (!string.IsNullOrEmpty(qrScanMessage))
    {
        <div class="alert alert-info mt-2">
            <i class="bi bi-check-circle"></i> @qrScanMessage
        </div>
    }
</div>

<AlertMessage Message="@viewModel.ErrorMessage" Type="danger" Icon="exclamation-triangle" />

@if (viewModel.IsLoading)
{
    <LoadingSpinner Message="Gegevens laden..." />
}
else
{
    <EditForm Model="@viewModel.NewTicket" OnValidSubmit="HandleSubmit" FormName="createTicketForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Bedrijf *</label>
                    <select class="form-select" value="@viewModel.NewTicket.CompanyID" @onchange="OnCompanyChanged">
                        <option value="0">-- Selecteer bedrijf --</option>
                        @foreach (var company in viewModel.Companies)
                        {
                            <option value="@company.CompanyID">@company.Name</option>
                        }
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Locatie</label>
                    <select class="form-select" value="@viewModel.NewTicket.Location" @onchange="OnLocationChanged">
                        <option value="">-- Selecteer locatie --</option>
                        @foreach (var location in viewModel.AvailableLocations)
                        {
                            <option value="@location">@location</option>
                        }
                    </select>
                    @if (viewModel.GetFilteredObjectCount() > 0 && !string.IsNullOrWhiteSpace(viewModel.NewTicket.Location))
                    {
                        <small class="text-muted">@viewModel.GetFilteredObjectCount() object(en) gevonden op deze locatie</small>
                    }
                    @if (viewModel.NewTicket.CompanyID == 0)
                    {
                        <small class="text-warning">Selecteer eerst een bedrijf</small>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">Object (optioneel)</label>
                    <InputSelect class="form-select" @bind-Value="viewModel.NewTicket.ObjectId">
                        <option value="">-- Geen object --</option>
                        @foreach (var obj in viewModel.GetFilteredObjects())
                        {
                            <option value="@obj.ObjectID">@obj.Name - @obj.Location</option>
                        }
                    </InputSelect>
                    @if (viewModel.NewTicket.CompanyID == 0)
                    {
                        <small class="text-warning">Selecteer eerst een bedrijf</small>
                    }
                </div>

                <div class="mb-3">
                    <label class="form-label">Monteur (optioneel)</label>
                    <InputSelect class="form-select" @bind-Value="viewModel.NewTicket.MechanicID">
                        <option value="">-- Nog niet toegewezen --</option>
                        @foreach (var mechanic in viewModel.Mechanics)
                        {
                            <option value="@mechanic.MechanicID">@mechanic.Name</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <div class="col-md-6">
                <div class="mb-3 form-check form-switch">
                    <InputCheckbox @bind-Value="viewModel.NewTicket.IsUrgent"
                                   class="form-check-input"
                                   id="spoed" />
                    <label class="form-check-label" for="spoed">
                        <span class="badge bg-danger">🚨 SPOED</span>
                        Directe aandacht nodig
                    </label>
                </div>

                <div class="mb-3">
                    <label class="form-label">Prioriteit *</label>
                    <InputSelect class="form-select" @bind-Value="viewModel.NewTicket.Priority">
                        @foreach (Priority priority in Enum.GetValues(typeof(Priority)))
                        {
                            <option value="@priority">@priority</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Reactietijd *</label>
                    <InputSelect class="form-select" @bind-Value="viewModel.NewTicket.ReactionTime">
                        @foreach (ReactionTime reactionTime in Enum.GetValues(typeof(ReactionTime)))
                        {
                            <option value="@reactionTime">@reactionTime</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Aangemaakt door *</label>
                    <InputText class="form-control" @bind-Value="viewModel.NewTicket.CreatedBy" placeholder="Jouw naam" />
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Beschrijving *</label>
            <InputTextArea class="form-control" @bind-Value="viewModel.NewTicket.Description" rows="4" placeholder="Beschrijf het probleem..." />
        </div>

        <div class="mb-3">
            <label class="form-label">Notitie (optioneel)</label>
            <InputTextArea class="form-control" @bind-Value="viewModel.NewTicket.Note" rows="3" placeholder="Extra informatie..." />
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary" disabled="@viewModel.IsSaving">
                @if (viewModel.IsSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Ticket Aanmaken
            </button>
            <button type="button" class="btn btn-outline-secondary" @onclick="UploadPhoto">
                <i class="bi bi-camera"></i> Upload Foto
            </button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Annuleren</button>
        </div>
    </EditForm>
}

<!-- QR Scanner Component -->
<QRCodeScanner IsVisible="@showQRScanner"
               OnCodeScanned="HandleQRCodeScanned"
               OnClose="CloseQRScanner" />

@code {
    private CreateTicketViewModel viewModel = new();

    private bool showQRScanner = false;
    private string qrScanMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        viewModel.OnStateChanged += StateHasChanged;

        // Laad basis data (companies en mechanics)
        await viewModel.LoadInitialDataAsync(
            () => ApiService.GetAllCompaniesAsync(),
            () => ApiService.GetActiveMechanicsAsync()
        );

        // Check voor objectId in URL (van Object Details "Nieuw Ticket" button)
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var objectIdParam = query["objectId"];

        if (!string.IsNullOrEmpty(objectIdParam) && int.TryParse(objectIdParam, out int objectId))
        {
            // Pre-fill from object!
            await viewModel.PreFillFromObjectAsync(
                objectId,
                ObjectApiService.GetObjectByIdAsync,
                ObjectApiService.GetLocationsByCompanyAsync,
                ObjectApiService.GetObjectsByCompanyAsync
            );

            qrScanMessage = $"✅ Ticket vooraf ingevuld met object gegevens";
        }
    }

    private void OpenQRScanner()
    {
        showQRScanner = true;
        qrScanMessage = string.Empty;
    }

    private void CloseQRScanner()
    {
        showQRScanner = false;
    }

    private async Task HandleQRCodeScanned(string qrCode)
    {
        showQRScanner = false;

        try
        {
            int objectId = ExtractObjectIdFromQRCode(qrCode);

            if (objectId > 0)
            {
                // Gebruik dezelfde PreFillFromObjectAsync method!
                await viewModel.PreFillFromObjectAsync(
                    objectId,
                    ObjectApiService.GetObjectByIdAsync,
                    ObjectApiService.GetLocationsByCompanyAsync,
                    ObjectApiService.GetObjectsByCompanyAsync
                );

                // Haal object op voor message
                var scannedObject = await ObjectApiService.GetObjectByIdAsync(objectId);
                if (scannedObject != null)
                {
                    qrScanMessage = $"✅ Object gescand: {scannedObject.Name} - {scannedObject.Location}";
                }
            }
            else
            {
                viewModel.ErrorMessage = "Ongeldige QR code. Kon geen object ID vinden.";
            }
        }
        catch (Exception ex)
        {
            viewModel.ErrorMessage = $"Fout bij verwerken van QR code: {ex.Message}";
        }

        StateHasChanged();
    }

    private int ExtractObjectIdFromQRCode(string qrCode)
    {
        // Direct nummer
        if (int.TryParse(qrCode, out int id))
        {
            return id;
        }

        // Format: "OBJECT:123"
        if (qrCode.StartsWith("OBJECT:", StringComparison.OrdinalIgnoreCase))
        {
            var numberPart = qrCode.Substring(7);
            if (int.TryParse(numberPart, out id))
            {
                return id;
            }
        }

        // Format: "OBJ-123"
        if (qrCode.StartsWith("OBJ-", StringComparison.OrdinalIgnoreCase))
        {
            var numberPart = qrCode.Substring(4);
            if (int.TryParse(numberPart, out id))
            {
                return id;
            }
        }

        // Probeer als JSON
        try
        {
            var json = System.Text.Json.JsonDocument.Parse(qrCode);
            if (json.RootElement.TryGetProperty("ObjectID", out var objIdProp))
            {
                return objIdProp.GetInt32();
            }
        }
        catch { }

        return 0;
    }

    private async Task OnCompanyChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int companyId))
        {
            viewModel.SetCompany(companyId);

            if (companyId > 0)
            {
                await viewModel.LoadCompanyDataAsync(
                    companyId,
                    ObjectApiService.GetLocationsByCompanyAsync,
                    ObjectApiService.GetObjectsByCompanyAsync
                );
            }
        }
    }

    private void OnLocationChanged(ChangeEventArgs e)
    {
        viewModel.SetLocation(e.Value?.ToString() ?? string.Empty);
    }

    private async Task HandleSubmit()
    {
        // Als spoed, override priority en reaction time
        if (viewModel.NewTicket.IsUrgent)
        {
            viewModel.NewTicket.Priority = Priority.Critical;
            viewModel.NewTicket.ReactionTime = ReactionTime.Within4Hours;
        }

        var result = await viewModel.SaveTicketAsync(async (ticket) =>
        {
            return await ApiService.CreateTicketAsync(ticket);
        });

        if (result != null)
        {
            Navigation.NavigateTo("/ticket");
        }
    }

    private void UploadPhoto()
    {
        viewModel.ErrorMessage = "Foto upload is nog niet geïmplementeerd";
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/ticket");
    }

    public void Dispose()
    {
        viewModel.OnStateChanged -= StateHasChanged;
    }
}