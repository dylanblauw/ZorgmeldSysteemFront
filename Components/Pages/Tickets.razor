@page "/Tickets"
@using ZorgmeldSysteem.Blazor.Models.DTOs.Ticket
@using ZorgmeldSysteem.Blazor.Models.Enums
@using ZorgmeldSysteem.Blazor.Services
@inject TicketApiService TicketApiService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Tickets Overzicht</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Tickets Overzicht</h3>
        <button class="btn btn-primary" @onclick="GoToCreateTicket">
            <i class="bi bi-plus-circle"></i> Nieuw Ticket
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3">Tickets laden...</p>
        </div>
    }
    else if (tickets.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Geen tickets gevonden.
        </div>
    }
    else
    {
        <!-- Filter sectie -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Zoeken</label>
                        <input type="text" class="form-control" @bind="searchQuery" @bind:event="oninput" placeholder="Zoek op ticketcode of beschrijving..." />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="filterStatus">
                            <option value="">Alle statussen</option>
                            @foreach (TicketStatus status in Enum.GetValues(typeof(TicketStatus)))
                            {
                                <option value="@((int)status)">@status</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Prioriteit</label>
                        <select class="form-select" @bind="filterPriority">
                            <option value="">Alle prioriteiten</option>
                            @foreach (Priority priority in Enum.GetValues(typeof(Priority)))
                            {
                                <option value="@((int)priority)">@priority</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary w-100" @onclick="ClearFilters">
                            <i class="bi bi-x-circle"></i> Reset Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets tabel -->
        <div class="card">
            <div class="card-body">
                <p class="text-muted">@FilteredTickets.Count van @tickets.Count tickets</p>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ticket Code</th>
                                <th>Beschrijving</th>
                                <th>Bedrijf</th>
                                <th>Status</th>
                                <th>Prioriteit</th>
                                <th>Aangemaakt</th>
                                <th>Acties</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ticket in FilteredTickets)
                            {
                                <tr style="cursor: pointer;" @onclick="() => ViewTicket(ticket.TicketID)">
                                    <td><strong>@ticket.TicketCode</strong></td>
                                    <td>@ticket.Description</td>
                                    <td>@ticket.CompanyName</td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(ticket.Status)">
                                            @ticket.Status
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @GetPriorityBadgeClass(ticket.Priority)">
                                            @ticket.Priority
                                        </span>
                                    </td>
                                    <td>@ticket.CreatedOn.ToString("dd-MM-yyyy HH:mm")</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ViewTicket(ticket.TicketID)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<TicketDto> tickets = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    // Filters
    private string searchQuery = string.Empty;
    private string filterStatus = string.Empty;
    private string filterPriority = string.Empty;

    private List<TicketDto> FilteredTickets
    {
        get
        {
            var filtered = tickets.AsEnumerable();

            // Zoek filter
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                filtered = filtered.Where(t =>
                    t.TicketCode.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    t.Description.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    t.CompanyName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
                );
            }

            // Status filter
            if (!string.IsNullOrWhiteSpace(filterStatus))
            {
                var status = (TicketStatus)int.Parse(filterStatus);
                filtered = filtered.Where(t => t.Status == status);
            }

            // Prioriteit filter
            if (!string.IsNullOrWhiteSpace(filterPriority))
            {
                var priority = (Priority)int.Parse(filterPriority);
                filtered = filtered.Where(t => t.Priority == priority);
            }

            return filtered.ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            tickets = await TicketApiService.GetAllTicketsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van tickets: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        searchQuery = string.Empty;
        filterStatus = string.Empty;
        filterPriority = string.Empty;
    }

    private void ViewTicket(int ticketId)
    {
        Navigation.NavigateTo($"/ticket/{ticketId}");
    }

    private void GoToCreateTicket()
    {
        Navigation.NavigateTo("/ticket/create");
    }

    private string GetStatusBadgeClass(TicketStatus status)
    {
        return status switch
        {
            TicketStatus.Open => "bg-warning",
            TicketStatus.Assigned => "bg-info",
            TicketStatus.InProgress => "bg-primary",
            TicketStatus.Solved => "bg-success",
            TicketStatus.Closed => "bg-secondary",
            TicketStatus.Cancelled => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetPriorityBadgeClass(Priority priority)
    {
        return priority switch
        {
            Priority.Low => "bg-secondary",
            Priority.Normal => "bg-info",
            Priority.High => "bg-warning",
            Priority.Urgent => "bg-danger",
            Priority.Critical => "bg-dark text-white",
            _ => "bg-secondary"
        };
    }
}