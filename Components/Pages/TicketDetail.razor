@page "/ticket/{TicketId:int}"
@page "/ticket/edit/{TicketId:int}"
@using ZorgmeldSysteem.Blazor.Models.DTOs.Ticket
@using ZorgmeldSysteem.Blazor.Models.DTOs.Company
@using ZorgmeldSysteem.Blazor.Models.DTOs.Mechanic
@using ZorgmeldSysteem.Blazor.Models.DTOs.Object
@using ZorgmeldSysteem.Blazor.Models.Enums
@using ZorgmeldSysteem.Blazor.Services;
@using ZorgmeldSysteem.Blazor.Services.Api
@inject TicketApiService ApiService
@inject ObjectApiService ObjectApiService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>@(isEditMode ? "Ticket Bewerken" : "Ticket Details")</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
            @if (isEditMode)
            {
                <span>Ticket Bewerken: @ticket?.TicketCode</span>
            }
            else
            {
                <span>Ticket Details: @ticket?.TicketCode</span>
            }
        </h3>
        <div>
            @if (!isEditMode && ticket != null)
            {
                <button class="btn btn-warning me-2" @onclick="EnableEditMode">
                    <i class="bi bi-pencil"></i> Bewerken
                </button>
            }
            <button class="btn btn-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Terug
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success" role="alert">
            @successMessage
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
            <p class="mt-3">Ticket laden...</p>
        </div>
    }
    else if (ticket == null)
    {
        <div class="alert alert-warning">
            Ticket niet gevonden.
        </div>
    }
    else
    {
        <!-- Status badges bovenaan -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <small class="text-muted">Status</small>
                        <div>
                            <span class="badge @GetStatusBadgeClass(ticket.Status) fs-6">
                                @GetStatusDisplayName(ticket.Status)
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Prioriteit</small>
                        <div>
                            <span class="badge @GetPriorityBadgeClass(ticket.Priority) fs-6">
                                <i class="bi @GetPriorityIcon(ticket.Priority)"></i>
                                @GetPriorityDisplayName(ticket.Priority)
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Aangemaakt op</small>
                        <div>@ticket.CreatedOn.ToString("dd-MM-yyyy HH:mm")</div>
                    </div>
@*                     <div class="col-md-3">
                        <small class="text-muted">Laatst bijgewerkt</small>
                        <div>@(ticket.UpdatedOn?.ToString("dd-MM-yyyy HH:mm") ?? "-")</div>
                    </div> *@
                </div>
            </div>
        </div>
    
        <EditForm Model="@ticket" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Bedrijf *</label>
                        @if (isEditMode)
                        {
                            <select class="form-select" @onchange="OnCompanyChangedHandler" disabled="@(!isEditMode)">
                                <option value="0">-- Selecteer bedrijf --</option>
                                @foreach (CompanyDto company in companies)
                                {
                                    <option value="@company.CompanyID" selected="@(company.CompanyID == ticket.CompanyID)">
                                        @company.Name
                                    </option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@ticket.CompanyName" readonly />
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Locatie</label>
                        @if (isEditMode)
                        {
                            <select class="form-select" value="@ticket.Location" @onchange="OnLocationChangedHandler">
                                <option value="">-- Selecteer locatie --</option>
                                @foreach (string location in availableLocations)
                                {
                                    <option value="@location" selected="@(location == ticket.Location)">@location</option>
                                }
                            </select>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@(ticket.Location ?? "-")" readonly />
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Object</label>
                        @if (isEditMode)
                        {
                            <InputSelect class="form-select" @bind-Value="ticket.ObjectId">
                                <option value="">-- Geen object --</option>
                                @foreach (ObjectDto obj in filteredObjects)
                                {
                                    <option value="@obj.ObjectID">@obj.Name - @obj.Location</option>
                                }
                            </InputSelect>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@(ticket.ObjectName ?? "-")" readonly />
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Monteur</label>
                        @if (isEditMode)
                        {
                            <InputSelect class="form-select" @bind-Value="ticket.MechanicID">
                                <option value="">-- Nog niet toegewezen --</option>
                                @foreach (MechanicDto mechanic in mechanics)
                                {
                                    <option value="@mechanic.MechanicID">@mechanic.Name</option>
                                }
                            </InputSelect>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@(ticket.MechanicName ?? "Niet toegewezen")" readonly />
                        }
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        @if (isEditMode)
                        {
                            <InputSelect class="form-select" @bind-Value="ticket.Status">
                                @foreach (TicketStatus status in Enum.GetValues(typeof(TicketStatus)))
                                {
                                    <option value="@status">@GetStatusDisplayName(status)</option>
                                }
                            </InputSelect>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@GetStatusDisplayName(ticket.Status)" readonly />
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Prioriteit *</label>
                        @if (isEditMode)
                        {
                            <InputSelect class="form-select" @bind-Value="ticket.Priority">
                                @foreach (Priority priority in Enum.GetValues(typeof(Priority)))
                                {
                                    <option value="@priority">@GetPriorityDisplayName(priority)</option>
                                }
                            </InputSelect>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@GetPriorityDisplayName(ticket.Priority)" readonly />
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reactietijd *</label>
                        @if (isEditMode)
                        {
                            <InputSelect class="form-select" @bind-Value="ticket.ReactionTime">
                                @foreach (ReactionTime reactionTime in Enum.GetValues(typeof(ReactionTime)))
                                {
                                    <option value="@reactionTime">@reactionTime</option>
                                }
                            </InputSelect>
                        }
                        else
                        {
                            <input type="text" class="form-control" value="@ticket.ReactionTime.ToString()" readonly />
                        }
                    </div>

@*                     <div class="mb-3">
                        <label class="form-label">Aangemaakt door</label>
                        <input type="text" class="form-control" value="@ticket.CreatedBy" readonly />
                    </div> *@
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Beschrijving *</label>
                @if (isEditMode)
                {
                    <InputTextArea class="form-control" @bind-Value="ticket.Description" rows="4" />
                }
                else
                {
                    <textarea class="form-control" rows="4" readonly>@ticket.Description</textarea>
                }
            </div>

            <div class="mb-3">
                <label class="form-label">Notitie</label>
                @if (isEditMode)
                {
                    <InputTextArea class="form-control" @bind-Value="ticket.Note" rows="3" />
                }
                else
                {
                    <textarea class="form-control" rows="3" readonly>@(ticket.Note ?? "-")</textarea>
                }
            </div>

            @if (isEditMode)
            {
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-save"></i> Opslaan
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                        <i class="bi bi-x-circle"></i> Annuleren
                    </button>
                </div>
            }
        </EditForm>

     @*    <!-- Historie sectie (alleen in view mode) -->
        @if (!isEditMode && ticket.History != null && ticket.History.Count > 0)
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Historie</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        @foreach (TicketHistoryDto history in ticket.History.OrderByDescending(h => h.CreatedOn))
                        {
                            <div class="timeline-item">
                                <small class="text-muted">@history.CreatedOn.ToString("dd-MM-yyyy HH:mm")</small>
                                <p class="mb-1">@history.Description</p>
                                <small class="text-muted">Door: @history.CreatedBy</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        } *@
    }
</div>

<style>
    .timeline-item {
        padding: 10px;
        border-left: 3px solid #dee2e6;
        margin-left: 10px;
        margin-bottom: 15px;
    }

    .timeline-item:hover {
        background-color: #f8f9fa;
        border-left-color: #007bff;
    }
</style>

@code {
    [Parameter] public int TicketId { get; set; }

    private TicketDto? ticket;
    private List<CompanyDto> companies = new();
    private List<MechanicDto> mechanics = new();
    private List<ObjectDto> availableObjects = new();
    private List<ObjectDto> filteredObjects = new();
    private List<string> availableLocations = new();

    private bool isLoading = true;
    private bool isSaving = false;
    private bool isEditMode = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Check of we in edit mode zijn gebaseerd op de URL
        isEditMode = Navigation.Uri.Contains("/edit/");

        await LoadTicket();
        await LoadDropdownData();
    }

    private async Task LoadTicket()
    {
        try
        {
            isLoading = true;
            ticket = await ApiService.GetTicketByIdAsync(TicketId);

            if (ticket != null && ticket.CompanyID > 0)
            {
                await LoadCompanySpecificData(ticket.CompanyID);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van ticket: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDropdownData()
    {
        try
        {
            Task<List<CompanyDto>> companiesTask = ApiService.GetAllCompaniesAsync();
            Task<List<MechanicDto>> mechanicsTask = ApiService.GetActiveMechanicsAsync();

            await Task.WhenAll(companiesTask, mechanicsTask);

            companies = await companiesTask;
            mechanics = await mechanicsTask;
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van data: {ex.Message}";
        }
    }

    private async Task LoadCompanySpecificData(int companyId)
    {
        try
        {
            Task<List<string>> locationsTask = ObjectApiService.GetLocationsByCompanyAsync(companyId);
            Task<List<ObjectDto>> objectsTask = ObjectApiService.GetObjectsByCompanyAsync(companyId);

            await Task.WhenAll(locationsTask, objectsTask);

            availableLocations = await locationsTask;
            availableObjects = await objectsTask;
            FilterObjectsByLocation();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van bedrijfsgegevens: {ex.Message}";
        }
    }

    private async Task OnCompanyChangedHandler(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int companyId) && ticket != null)
        {
            ticket.CompanyID = companyId;

            if (companyId > 0)
            {
                await LoadCompanySpecificData(companyId);
                ticket.Location = string.Empty;
                ticket.ObjectId = null;
            }
            else
            {
                availableLocations.Clear();
                availableObjects.Clear();
                filteredObjects.Clear();
            }
        }
    }

    private void OnLocationChangedHandler(ChangeEventArgs e)
    {
        if (ticket != null)
        {
            ticket.Location = e.Value?.ToString() ?? string.Empty;
            FilterObjectsByLocation();
        }
    }

    private void FilterObjectsByLocation()
    {
        if (ticket == null)
        {
            filteredObjects = new List<ObjectDto>();
            return;
        }

        if (string.IsNullOrWhiteSpace(ticket.Location))
        {
            filteredObjects = new List<ObjectDto>(availableObjects);
        }
        else
        {
            filteredObjects = availableObjects
                .Where(obj => obj.Location.Equals(ticket.Location, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private async Task HandleSubmit()
    {
        if (ticket == null) return;

        isSaving = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            UpdateTicketDto updateDto = new UpdateTicketDto
                {
                    // TicketID = ticket.TicketID,
                    // CompanyID = ticket.CompanyID,
                    Description = ticket.Description,
                    Status = ticket.Status,
                    Priority = ticket.Priority,
                    ReactionTime = ticket.ReactionTime,
                    Location = ticket.Location,
                    // ObjectId = ticket.ObjectId,
                    MechanicID = ticket.MechanicID,
                    Note = ticket.Note,
                    // UpdatedBy = "Huidige Gebruiker" // Dit zou uit auth moeten komen
                };

            TicketDto? result = await ApiService.UpdateTicketAsync(ticket.TicketID, updateDto);

            if (result != null)
            {
                ticket = result;
                successMessage = "Ticket succesvol bijgewerkt!";
                isEditMode = false;

                // Herlaad de ticket om de laatste versie te krijgen
                await LoadTicket();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij opslaan: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void EnableEditMode()
    {
        isEditMode = true;
        successMessage = string.Empty;
    }

    private async Task CancelEdit()
    {
        isEditMode = false;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Herlaad de originele data
        await LoadTicket();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/Tickets");
    }

    // Helper methodes voor display
    private string GetStatusDisplayName(TicketStatus status) => status switch
    {
        TicketStatus.Open => "Open",
        TicketStatus.Assigned => "Toegewezen",
        TicketStatus.InProgress => "In Behandeling",
        TicketStatus.Solved => "Opgelost",
        TicketStatus.Closed => "Gesloten",
        TicketStatus.Cancelled => "Geannuleerd",
        _ => status.ToString()
    };

    private string GetPriorityDisplayName(Priority priority) => priority switch
    {
        Priority.Low => "Laag",
        Priority.Normal => "Normaal",
        Priority.High => "Hoog",
        Priority.Urgent => "Urgent",
        Priority.Critical => "Kritiek",
        _ => priority.ToString()
    };

    private string GetStatusBadgeClass(TicketStatus status) => status switch
    {
        TicketStatus.Open => "bg-warning text-dark",
        TicketStatus.Assigned => "bg-info",
        TicketStatus.InProgress => "bg-primary",
        TicketStatus.Solved => "bg-success",
        TicketStatus.Closed => "bg-secondary",
        TicketStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetPriorityBadgeClass(Priority priority) => priority switch
    {
        Priority.Low => "bg-secondary",
        Priority.Normal => "bg-info",
        Priority.High => "bg-warning text-dark",
        Priority.Urgent => "bg-danger",
        Priority.Critical => "bg-dark",
        _ => "bg-secondary"
    };

    private string GetPriorityIcon(Priority priority) => priority switch
    {
        Priority.Low => "bi-arrow-down",
        Priority.Normal => "bi-dash",
        Priority.High => "bi-arrow-up",
        Priority.Urgent => "bi-exclamation-triangle",
        Priority.Critical => "bi-exclamation-octagon",
        _ => "bi-dash"
    };
}