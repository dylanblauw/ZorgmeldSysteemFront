@page "/mechanic/create"
@using ZorgmeldSysteem.Blazor.Models.DTOs.Mechanic
@using ZorgmeldSysteem.Blazor.Models.DTOs.Company
@using ZorgmeldSysteem.Blazor.Models.Enums
@using ZorgmeldSysteem.Blazor.Services.Api
@inject MechanicApiService MechanicApiService
@inject CompanyApiService CompanyApiService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Nieuwe Monteur Aanmaken</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Nieuwe Monteur Aanmaken</h3>
        <button class="btn btn-secondary" @onclick="Cancel">
            <i class="bi bi-arrow-left"></i> Terug
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    <div class="card">
        <div class="card-body">
            <EditForm Model="@newMechanic" OnValidSubmit="HandleSubmit" FormName="createMechanicForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <h5 class="card-title mb-3">Persoonlijke Informatie</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Naam *</label>
                            <InputText class="form-control"
                                       @bind-Value="newMechanic.Name"
                                       placeholder="Voornaam Achternaam" />
                            <ValidationMessage For="@(() => newMechanic.Name)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <InputText type="email"
                                       class="form-control"
                                       @bind-Value="newMechanic.Email"
                                       placeholder="monteur@bedrijf.nl" />
                            <ValidationMessage For="@(() => newMechanic.Email)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Telefoonnummer</label>
                            <InputText class="form-control"
                                       @bind-Value="newMechanic.Phonenumber"
                                       placeholder="06-12345678" />
                            <ValidationMessage For="@(() => newMechanic.Phonenumber)" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Type Monteur *</label>
                            <InputSelect class="form-select" @bind-Value="newMechanic.Type">
                                <option value="">-- Selecteer type --</option>
                                @foreach (MechanicType type in Enum.GetValues(typeof(MechanicType)))
                                {
                                    <option value="@type">@GetMechanicTypeDisplayName(type)</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => newMechanic.Type)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Bedrijf *</label>
                            <InputSelect class="form-select" @bind-Value="newMechanic.CompanyID">
                                <option value="0">-- Selecteer bedrijf --</option>
                                @foreach (var company in companies)
                                {
                                    <option value="@company.CompanyID">@company.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => newMechanic.CompanyID)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Tijdelijk Wachtwoord *</label>
                            <InputText type="password"
                                       class="form-control"
                                       @bind-Value="newMechanic.TempPassword"
                                       placeholder="Minimaal 8 karakters" />
                            <ValidationMessage For="@(() => newMechanic.TempPassword)" />
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                De monteur moet dit wachtwoord gebruiken bij eerste login en kan het daarna wijzigen.
                            </small>
                        </div>
                    </div>
                </div>

                <hr class="my-4" />

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Bezig met aanmaken...</span>
                        }
                        else
                        {
                            <i class="bi bi-save"></i>
                            <span>Monteur Aanmaken</span>
                        }
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancel" disabled="@isSaving">
                        Annuleren
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="mt-3 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
        </div>
    }
</div>

@code {
    private CreateMechanicDto newMechanic = new();
    private List<CompanyDto> companies = new();
    private bool isSaving = false;
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
    }

    private async Task LoadCompanies()
    {
        isLoading = true;
        try
        {
            companies = await CompanyApiService.GetAllCompaniesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij laden van bedrijven: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        // Extra validatie
        if (newMechanic.CompanyID == 0)
        {
            errorMessage = "Selecteer een bedrijf.";
            return;
        }

        if (string.IsNullOrEmpty(newMechanic.TempPassword) || newMechanic.TempPassword.Length < 8)
        {
            errorMessage = "Wachtwoord moet minimaal 8 karakters bevatten.";
            return;
        }

        isSaving = true;
        errorMessage = string.Empty;

        try
        {
            var result = await MechanicApiService.CreateMechanicAsync(newMechanic);

            if (result != null)
            {
                // Succes - navigeer naar overzicht
                Navigation.NavigateTo("/mechanics");
            }
            else
            {
                errorMessage = "Er is een fout opgetreden bij het aanmaken van de monteur. Mogelijk bestaat het email adres al.";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Netwerkfout: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Fout bij aanmaken monteur: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/mechanics");
    }

    private string GetMechanicTypeDisplayName(MechanicType type)
    {
        return type switch
        {
            MechanicType.InternalGeneral => "Intern - Algemeen",
            MechanicType.InternalElectrical => "Intern - Elektra",
            MechanicType.InternalPlumbing => "Intern - Loodgieter",
            MechanicType.InternalHVAC => "Intern - HVAC",
            MechanicType.ExternalElectrical => "Extern - Elektra",
            MechanicType.ExternalPlumbing => "Extern - Loodgieter",
            MechanicType.ExternalHVAC => "Extern - HVAC",
            MechanicType.ExternalCleaning => "Extern - Schoonmaak",
            MechanicType.ExternalSecurity => "Extern - Beveiliging",
            MechanicType.ExternalIT => "Extern - IT",
            MechanicType.ExternalGeneral => "Extern - Algemeen",
            _ => type.ToString()
        };
    }
}
